<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8"/>
        <title>Reversi</title>
        <style>
            table#gridTable{
                background-color:green;
            }
            .gridCell{
                height:50px;
                width:50px;
                border:2px solid black;
            }
            #container{
                background-color:bisque;
                height:90vh;
                display:flex;
                justify-content:space-evenly;
                flex-direction: column;
                align-items:center;
            }
            thead, tfoot{
                background-color:white;
                text-align:center;
            }
            .gridCellNumber{
                background-color:white;
                height:50px;
                width:25px;
                border-collapse:collapse;
                text-align:center;
                line-height:50px;
            }
            .buffer{
                background-color:white;
                height:25px;
                width:25px;
            }
            .diskPlayer1{
                background-color:black;
                height:50px;
                width:50px;
                border-radius:50%;
            }
            .diskPlayer2{
                background-color:white;
                height:50px;
                width:50px;
                border-radius:50%;
            }
            .diskHighlight{
                background-color:yellow;
                height:50px;
                width:50px;
                animation:blink 0.75s infinite alternate;
            }
            #menu{
                background-color:gray;
                display:flex;
                justify-content:space-evenly;
                align-items:center;
            }
            #timer{
                font: 30px "Courier New", Courier, monospace;
                background-color:lightgreen;
            }
            #player1Info, #player2Info{
                line-height:0;
            }
            @keyframes blink
            {
                from{
                    opacity:0.75;
                }
                to{
                    opacity:0.25;
                }
            }
        </style>
        <script src="https://code.jquery.com/jquery-1.10.2.js"></script>

    </head>
    <body>
        <form id="opponentType">
            <h2>Play Against:</h2>
            <input type="button" value="Person" onclick="setOpponentType(this)">
            <input type="button" value="Computer" onclick="setOpponentType(this)">
        </form>
        <form id="sizeForm">
            <label for="layoutSize">Select Grid Size:</label>
            <select id=layoutSize>
                <option>4x4</option>
                <option>6x6</option>
                <option>8x8</option>
            </select>
            <input type="button" value="Submit" onclick="setGridSize();"/>
        </form>
        <div id="menu">
            <table id="player1">
                <tr>
                    <td>
                        <form>
                            <select id="diskColorSelector1">
                                <option value="red">Red</option>
                                <option value="blue">Blue</option>
                            </select>
                        </form>
                    </td>
                    <td>
                        <input type="button" value="Change Disk Color" onclick="changeDiskColor();"/>
                    </td>
                </tr>
                <tr>
                    <td colspan="2">
                        <p id="player1Info">Player 1 has 0 disks</p>
                    </td>
                </tr>
            </table>
            <div id="timer"></div>
            <table id="player2">
                    <tr>
                        <td>
                            <form>
                                <select id="diskColorSelector2">
                                    <option value="red">Red</option>
                                    <option value="blue">Blue</option>
                                </select>
                            </form>
                        </td>
                        <td>
                            <input type="button" value="Change Disk Color" onclick="changeDiskColor();"/>
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2">
                            <p id="player2Info">Player 2 has 0 disks</p>
                        </td>
                    </tr>
                </table>
        </div>
        <div id="container">

        </div>
    </body>
    <script>
        var currentPlayer = 1;
        var startTime;
        var gridSize;
        var turn = 1;
        var table;
        var opponentType;
        var directions = [
            {   // row up
                "initRow":"row = rowIndex - 1",
                "initColumn":"column = columnIndex",
                "operation":"row--",
                "check":"row >= 0"
            },
            {   // row down
                "initRow":"row = rowIndex + 1",
                "initColumn":"column = columnIndex",
                "operation":"row++",
                "check":"row < gridSize"
            },
            {   // column left
                "initRow":"row = rowIndex",
                "initColumn":"column = columnIndex - 1",
                "operation":"column--",
                "check":"column >= 0"
            },
            {   // column right
                "initRow":"row = rowIndex",
                "initColumn":"column = columnIndex + 1",
                "operation":"column++",
                "check":"column <= gridSize"
            },
            {   // top left diagonal
                "initRow":"row = rowIndex - 1",
                "initColumn":"column = columnIndex - 1",
                "operation":"column--; row--",
                "check":"row >= 0 && column >= 0"
            },
            {   // top right diagonal
                "initRow":"row = rowIndex - 1",
                "initColumn":"column = columnIndex + 1",
                "operation":"column++; row--",
                "check":"row >= 0 && column <= gridSize"
            },
            {   // bottom left diagonal
                "initRow":"row = rowIndex + 1",
                "initColumn":"column = columnIndex - 1",
                "operation":"column--; row++",
                "check":"row < gridSize && column >= 0"
            },
            {   // bottom right diagonal
                "initRow":"row = rowIndex + 1",
                "initColumn":"column = columnIndex + 1",
                "operation":"column++; row++",
                "check":"row < gridSize && column <= gridSize"
            }
        ]
        $(document).ready(function(){
            $("#menu").hide();
            $("#container").hide()
           // $("#sizeForm").hide();
        })
        function setOpponentType(clickedButton)
        {
            opponentType = clickedButton.value;
            //$("#sizeForm").show();
        }

        // user selects 4x4, 6x6, or 8x8
        function setGridSize()
        {
            $("#sizeForm").hide();
            $("#menu").show();
            $("#container").show()
            let selector = document.getElementById("layoutSize");
            gridSize = Number(selector.options[selector.selectedIndex].text[0]);
            drawGrid(gridSize);
            startTime = Date.now();
            setInterval(updateTimer, 1)
        }
        function drawGrid(gridSize)
        {
            let container = document.getElementById("container");
            table = document.createElement("TABLE");
            table.setAttribute("id", "gridTable");
            let tableHead = document.createElement("THEAD");
            let tableBody = document.createElement("TBODY");
            let tableFoot = document.createElement("TFOOT");

            container.appendChild(table);
            table.appendChild(tableHead);
            table.appendChild(tableBody);
            table.appendChild(tableFoot);

            var headerRow = tableHead.insertRow();
            headerRow.insertCell().innerHTML = "<div class='buffer'></div>";
            for(let i = 0; i < gridSize; i++)
                headerRow.insertCell().innerText = String.fromCharCode('a'.charCodeAt(0) + i);
            headerRow.insertCell().innerHTML = "<div class='buffer'></div>";

            for(let i = 0; i < gridSize; i++)
            {
                var row = tableBody.insertRow();
                row.insertCell().innerHTML = "<div class='gridCellNumber'>" + i + "</div>";
                for(let j = 0; j < gridSize; j++)
                    row.insertCell().innerHTML = "<div class='gridCell'></div>";
                row.insertCell().innerHTML = "<div class='gridCellNumber'>" + i + "</div>";
            }
            $(".gridCell").attr("onclick","playerTurn(this)");

            var footerRow = tableFoot.insertRow();
            footerRow.insertCell().innerHTML = "<div class='buffer'></div>";
            for(let i = 0; i < gridSize; i++)
                footerRow.insertCell().innerHTML = String.fromCharCode('a'.charCodeAt(0) + i);
            footerRow.insertCell().innerHTML = "<div class='buffer'></div>";

            // highlight center four cells
            highlight();

        }

        // highlight valid cells on new player's turn
        function setValidSpaces()
        {
            let opponent = "diskPlayer" + (currentPlayer == 1 ? "2" : "1");
            let currentPlayerSpots = document.getElementsByClassName("diskPlayer" + currentPlayer);
            
            if(turn > 4)
            {
                $(".diskHighlight").remove()    // remove previous player's highlighted spots
                for(let i = 0; i < currentPlayerSpots.length; i++)
                {
                    let [rowIndex, columnIndex] = getCoordinates(currentPlayerSpots[i]);
                    for(let i = 0; i < directions.length; i++)
                    {
                        count = 0;
                        eval(directions[i].initRow);
                        eval(directions[i].initColumn);

                        while(eval(directions[i].check))
                        {
                            let possibleOpponent = table.childNodes[1].rows[row].cells[column].childNodes[0];
                            if(possibleOpponent.hasChildNodes() && possibleOpponent.childNodes[0].className == opponent)
                                count++;
                            else
                                break;
                            eval(directions[i].operation);
                        }
                        if(count > 0 && eval(directions[i].check))
                        {
                            let possibleSpace = table.childNodes[1].rows[row].cells[column].childNodes[0];
                            if(!possibleSpace.hasChildNodes())
                                highlight(row, column);
                        }
                    }
                }
            }
        }

        // pass disk
        // return row and index of cell
        function getCoordinates(disk)
        {
            var columnIndex = parseInt($(disk).parent().parent().index());
            var rowIndex = parseInt($(disk).parent().parent().parent().index());
            return [rowIndex, columnIndex];
        }

        function playerTurn(gridCell)
        {
            if(isValidSpace(gridCell))
            {
                drawDisk(gridCell);
                flipDisks(gridCell.childNodes[0]);
                currentPlayer = currentPlayer == 1 ? 2 : 1;
                turn++;
                setValidSpaces();        
            }
            
        }
        $(document).keypress(function(e) {
            if(e.which == 13) {
                computerTurn();
            }
        });
        // return whether selected cell is highlighted
        function isValidSpace(gridCell)
        {
            return gridCell.hasChildNodes() && gridCell.childNodes[0].className=="diskHighlight"
        }

        // highlight either center cells or specified cell
        function highlight(row = null, column = null)
        {
            // first four turns - highlight middle four spaces
            if(turn <= 4)
            {
                let center = Math.floor(gridSize / 2);
                let disks = new Array(4);
                for(let i = 0; i < 4; i++)
                {
                    disks[i] = document.createElement("DIV");
                    disks[i].className = "diskHighlight";
                }
                table.rows[center].cells.item(center).childNodes[0].appendChild(disks[0]);
                table.rows[center].cells.item(center+1).childNodes[0].appendChild(disks[1]);
                table.rows[center+1].cells.item(center).childNodes[0].appendChild(disks[2]);
                table.rows[center+1].cells.item(center+1).childNodes[0].appendChild(disks[3]);
            }

            // past first four turns - highlight specified cell
            else
            {
                let disk = document.createElement("DIV");
                disk.className = "diskHighlight";
                table.childNodes[1].rows[row].cells.item(column).childNodes[0].appendChild(disk);
            }
        }

        // pass td
        function drawDisk(gridCell)
        {
            // remove highlighted space
            if(gridCell.hasChildNodes() && gridCell.childNodes[0].className == "diskHighlight")
            gridCell.removeChild(gridCell.childNodes[0]);
            
            // draw disk
            let disk = document.createElement("DIV");
            disk.className = "diskPlayer" + currentPlayer;
            if(!gridCell.hasChildNodes())
            {
                gridCell.appendChild(disk);
                console.log("Player " + currentPlayer + " placed disk");
                let player1Count = $(".diskPlayer1").length;
                updatePlayerDiskCount();
            }
        }
        function updatePlayerDiskCount()
        {
            $("#player1Info").html(`Player 1 has ${$(".diskPlayer1").length} disks`)
            $("#player2Info").html(`Player 2 has ${$(".diskPlayer2").length} disks`)
        }

        function computerTurn()
        {

                let highlightedDisks = Array.from(document.getElementsByClassName("diskHighlight"));
                let numDisksFlipped = highlightedDisks.map(x => flipDisks(x, true));
                console.log(numDisksFlipped);
                let indexOfMax = numDisksFlipped.indexOf(Math.max.apply(null, numDisksFlipped));

                let gridCell = highlightedDisks[indexOfMax].parentNode
                drawDisk(gridCell);
                flipDisks(gridCell.childNodes[0]);
                currentPlayer = currentPlayer == 1 ? 2 : 1;
                turn++;
                setValidSpaces();    

        }

        // pass td
        // change color of disks between new disk and old disks
        function flipDisks(disk, isTentative=false)
        {
            let [rowIndex, columnIndex] = getCoordinates(disk);
            let opponent = "diskPlayer" + (currentPlayer == 1 ? "2" : "1");
            let numCellsFlipped = 0;

            for(let i = 0; i < directions.length; i++)
            {
                count = 0;
                eval(directions[i].initRow);
                eval(directions[i].initColumn);
                let flipOpponents = new Array();
                while(eval(directions[i].check))
                {
                    let possibleOpponent = table.childNodes[1].rows[row].cells[column].childNodes[0];
                    if(possibleOpponent.hasChildNodes() && possibleOpponent.childNodes[0].className == opponent)
                    {
                        flipOpponents.push(possibleOpponent.childNodes[0]);
                        count++;
                    }
                    else if(possibleOpponent.hasChildNodes() && possibleOpponent.childNodes[0].className == "diskPlayer" + currentPlayer && count > 0)
                    {
                        if(!isTentative)
                        {
                            for(let j = 0; j < flipOpponents.length; j++)
                            {
                                console.log("flipped " + getCoordinates(flipOpponents[j]));
                                flipOpponents[j].className = "diskPlayer" + currentPlayer;
                            }
                            updatePlayerDiskCount();
                        }
                        else
                        {
                            numCellsFlipped += flipOpponents.length;
                        }
                    }
                    eval(directions[i].operation);
                }
            }
            return numCellsFlipped;
        }

        // change all player's disk color
        function changeDiskColor()
        {
            let selector = document.getElementById("diskColorSelector" + currentPlayer);
            let diskColor = selector.options[selector.selectedIndex].value;
            $("option[value='" + diskColor + "']").attr("disabled", "disabled");

            // change color for existing disks and future disks
            var stylesheet = document.styleSheets;
            for (var i = 0; i < stylesheet.length; i++) 
            {
                var styleList = stylesheet[i].cssRules || stylesheet[i].rules;
                for (var j = 0; j < styleList.length; j++) 
                    if (styleList[j].selectorText == ".diskPlayer" + currentPlayer)
                        styleList[j].style.backgroundColor = diskColor;
            }
        }
        function changeGridColor()
        {
            
        }
        function updateTimer()
        {
            let elapsedTime = Date.now() - startTime;
            let minutes = Math.floor((elapsedTime % 3600000) / 60000);
            let seconds = Math.floor((elapsedTime % 60000) / 1000);
            let milliseconds = Math.floor((elapsedTime % 60000) / 100);
           
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;

            let timer = document.getElementById("timer");
            timer.innerText = minutes + ":" + seconds;
        }
    </script>
</html>